# Excel导出功能测试指南

## ✅ 修复完成

Excel导出功能已修复，现在可以导出实际数据而非空白内容。

## 📊 可导出的内容

### 1. 风险信息列表（风险列表页面）

**位置**: 首页 → 风险列表 → 导出Excel按钮

**导出内容**:
- ID
- 公司名称
- 标题
- 风险事项
- 风险等级（高风险/中风险/低风险）
- 风险时间
- 来源
- 原文链接
- 创建时间

**数据量**: 当前筛选条件下的所有数据（约100条）

**文件名**: `风险信息列表-2025-12-31-XX-XX-XX.xlsx`

---

### 2. 企业信息列表（风险等级调整页面）

**位置**: 首页 → 风险等级调整 → 导出企业列表按钮

**导出内容**:
- 企业名称
- 统一社会信用代码
- 当前风险等级
- 风险数量
- 最后调整时间
- 调整人

**数据量**: 10家监控企业

**文件名**: `企业信息列表-2025-12-31-XX-XX-XX.xlsx`

---

### 3. 爬取网站源配置（数据源管理页面）

**位置**: 首页 → 数据源管理 → 导出Excel按钮

**导出内容**:
- 网站名称
- 爬取地址
- XPath规则
- 状态（正常/异常/停用）
- 爬取间隔(秒)
- 成功率(%)
- 最近爬取时间

**数据量**: 31个信息源

**文件名**: `爬取网站源配置-2025-12-31-XX-XX-XX.xlsx`

---

### 4. 风险等级调整历史（风险等级调整页面）

**位置**: 首页 → 风险等级调整 → 导出调整历史按钮

**导出内容**:
- 企业名称
- 调整前等级
- 调整后等级
- 调整原因
- 调整人
- 调整时间

**数据量**: 所有历史调整记录

**文件名**: `风险等级调整历史-2025-12-31-XX-XX-XX.xlsx`

---

## 🧪 测试步骤

### 测试1：导出风险列表

1. 访问平台：https://3000-i6owb9pva7rgt0fl8drog-5c13a017.sandbox.novita.ai
2. 点击顶部导航 "风险列表"
3. （可选）设置筛选条件：公司、风险等级、时间范围等
4. 点击 "导出Excel" 按钮
5. 确认导出对话框（显示数据条数）
6. 打开下载的Excel文件
7. ✅ 验证：应该看到表头和实际数据（约100条）

### 测试2：导出企业列表

1. 点击顶部导航 "风险等级调整"
2. 点击 "导出企业列表" 按钮
3. 确认导出对话框（显示10条）
4. 打开下载的Excel文件
5. ✅ 验证：应该看到10家企业的完整信息

### 测试3：导出数据源配置

1. 点击顶部导航 "数据源管理"
2. 点击 "导出Excel" 按钮
3. 确认导出对话框（显示31条）
4. 打开下载的Excel文件
5. ✅ 验证：应该看到31个信息源的配置信息

### 测试4：导出调整历史

1. 在 "风险等级调整" 页面
2. 点击 "导出调整历史" 按钮
3. 确认导出对话框
4. 打开下载的Excel文件
5. ✅ 验证：应该看到历史调整记录（如果有的话）

---

## 🔍 导出数据示例

### 风险信息列表示例

| ID | 公司名称 | 标题 | 风险事项 | 风险等级 | 风险时间 | 来源 | 原文链接 | 创建时间 |
|----|---------|------|---------|---------|---------|-----|---------|---------|
| 1 | 巴基斯坦PMLTC公司 | PMLTC Matiari-Lahore HVDC项目遭遇技术故障 | 电网中断影响供电 | 高风险 | 2025-09-25 | 路透社 | https://... | 2025-12-30 |
| 2 | 巴西CPFL公司 | 巴西CPFL面临监管机构罚款 | 违反环保规定 | 高风险 | 2025-10-06 | Bloomberg | https://... | 2025-12-30 |

### 数据源配置示例

| 网站名称 | 爬取地址 | XPath规则 | 状态 | 爬取间隔(秒) | 成功率(%) | 最近爬取时间 |
|---------|---------|-----------|-----|------------|----------|------------|
| grupocpfl(公司官网) | https://grupocpfl.com.br | //article \| //div[...] | 正常 | 3600 | 0 | 未爬取 |
| bloomberg(新闻媒体) | https://bloomberg.com | //article \| //div[...] | 正常 | 3600 | 0 | 未爬取 |

---

## 💡 技术实现细节

### 修复前的问题
- `exportToExcel`函数数据格式映射错误
- 数据对象的key与headers不匹配
- 导致导出的Excel只有表头没有数据

### 修复后的实现
```javascript
// 数据格式统一为 {表头: 值}
const exportData = risks.map(risk => ({
  'ID': risk.id,
  '公司名称': risk.company_name,
  '标题': risk.title,
  // ... 其他字段
}));

// 表头数组
const headers = ['ID', '公司名称', '标题', ...];

// 导出
exportToExcel(exportData, headers, '风险信息列表');
```

### 关键改进
1. **数据结构统一**: 数据对象的key直接使用中文表头
2. **字段兼容**: 支持驼峰命名和下划线命名（如`xpathRules`和`xpath_rules`）
3. **数据验证**: 添加空数据检查和提示
4. **日志输出**: 添加console.log便于调试
5. **用户确认**: 导出前显示数据条数

---

## ✨ 验收标准

所有导出功能应满足：
- ✅ 能够成功下载Excel文件
- ✅ 文件名包含时间戳
- ✅ 第一行是中文表头
- ✅ 包含实际数据行（非空白）
- ✅ 数据完整且格式正确
- ✅ 导出前有确认对话框
- ✅ 支持筛选条件导出

---

## 📞 问题排查

### 如果导出失败

1. **检查控制台**: 打开浏览器开发者工具查看错误信息
2. **检查XLSX库**: 确认页面已加载`xlsx.js`库
3. **检查网络**: 确认API能正常返回数据
4. **刷新页面**: 重新加载页面后再试

### 常见问题

**Q: 导出的Excel是空的？**
A: 这个问题已修复。如果仍然出现，请刷新页面清除缓存。

**Q: 导出时没有确认对话框？**
A: 检查浏览器是否禁用了弹窗。

**Q: 文件名乱码？**
A: 部分浏览器可能不支持中文文件名，但内容应该正常。

**Q: 某些字段为空？**
A: 这是正常的，表示该字段在数据库中没有值（如"最近爬取时间"为空表示还未爬取）。

---

## 🎉 测试完成

所有导出功能已修复并可正常使用！

**在线测试地址**: https://3000-i6owb9pva7rgt0fl8drog-5c13a017.sandbox.novita.ai
